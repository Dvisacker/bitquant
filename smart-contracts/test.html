<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- Copyright (c) 2014 - Bitquant Research Laboratories (Asia) --
  -- Ltd. -->
<!-- Redistributable under terms of the Simplified BSD License -->
<head>
<link href="https://code.jquery.com/ui/1.11.2/themes/ui-lightness/jquery-ui.css" rel="stylesheet"/>
<link href="jquery.appendGrid-1.5.0.min.css" rel="stylesheet"/>
<script src="http://requirejs.org/docs/release/2.1.15/minified/require.js"></script>
<script>
require.config({
    paths: {
        "moment": "node_modules/moment/moment",
	"jquery" : "http://code.jquery.com/jquery-2.0.0",
	"modernizr" : "http://cdn.jsdelivr.net/webshim/1.14.2/extras/modernizr-custom",
	"jquery-ui" : "http://code.jquery.com/ui/1.11.2/jquery-ui.min",
	"append-grid" :  "jquery.appendGrid-1.5.0.min",
	"polyfiller" : "http://cdn.jsdelivr.net/webshim/1.14.2/polyfiller"
    },
    shim: {
        "jquery-ui": {
            exports:"$" ,
            deps: ['jquery']
        },
        "jquery-migrate": ['jquery-ui'],
        "append-grid": ['jquery-ui'],
	"polyfiller" : {
	    exports: "webshims",
	    deps: ['modernizr']
	}
    },
    waitSeconds: 15
});

var calculate_me;

require ([
    "./TermSheet",
    "./LoanCalculator",
"append-grid",
"polyfiller"], function(TermSheet, LoanCalculator) {
    webshims.setOptions('forms-ext', {types: 'date'});

    calculate_me = function() {
	var my_term_sheet = new TermSheet.TermSheet();
	function money(a) {
	    return {"amount": Number(a), "ccy" : my_term_sheet.currency};
	}
	
	function new_date(a) {
	    var vars = a.split("-");
	    return new Date(vars[0], vars[1]-1, vars[2]);
	}

        var events = {
	    revenues : [],
	    early_payments : [],
	    credit_draws : [],
	    skip_principal : []
	};
        $('#revenueGrid').appendGrid('getAllValue').forEach(function(i) {
	    events.revenues.push( {
		on : new_date(i.date),
		amount : money(i.amount)
	    });
	});

       $('#early_payments').appendGrid('getAllValue').forEach(function(i) {
	    events.early_payments.push( {
		on : new_date(i.date),
		amount : money(i.amount)
	    });
	});
       $('#credit_draws').appendGrid('getAllValue').forEach(function(i) {
	    events.credit_draws.push( {
		on : new_date(i.date),
		amount : money(i.amount)
	    });
	});
       $('#skip_principal').appendGrid('getAllValue').forEach(function(i) {
	    events.skip_principal.push( {
		on : new_date(i.date)
	    });
	});

	my_term_sheet.set_events(events);
	calculator = new LoanCalculator.LoanCalculator();
        var payments = calculator.calculate(my_term_sheet);
	$('#item').html("");
	calculator.show_payments(my_term_sheet).forEach(function(i) {
	   $('#item').append(i.join(" "));
	   $('#item').append("\n");
	});
    };
    $(function() {
	$('#revenueGrid').appendGrid({
	    caption: "Revenue",
	    initRows: 0,
	    columns: [
		{ name: "date", display: "Date", type : 'date' },
		{ name: "amount", display : "Money", type : "text" }
	    ],
            afterRowInserted: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    },
            afterRowAppended: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    }
	});
	$('#early_payments').appendGrid({
	    caption: "Early payments",
	    initRows: 0,
	    columns: [
		{ name: "date", display: "Date", type : 'date' },
		{ name: "amount", display : "Money", type : "text" }
	    ],
            afterRowInserted: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    },
            afterRowAppended: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    }

	});

	$('#credit_draws').appendGrid({
	    caption: "Credit draws",
	    initRows: 0,
	    columns: [
		{ name: "date", display: "Date", type : 'date' },
		{ name: "amount", display : "Money", type : "text" }
	    ],
            afterRowInserted: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    },
            afterRowAppended: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    }
	});
	$('#skip_principal').appendGrid({
	    caption: "Skip principal",
	    initRows: 0,
	    columns: [
		{ name: "date", display: "Date", type : 'date' }
	    ],
            afterRowInserted: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    },
            afterRowAppended: function(caller,
				       parentRow,
				       addedRow) {
		$(caller).updatePolyfill();
	    }
	});
	webshims.polyfill('forms forms-ext es5');
    });
});

</script>

</head>
<body>
Worlds first smart contract.<br>
<button id="btnSerialize" onclick="calculate_me()" type="button">Calculate</button>
<table id="revenueGrid" class="hasdate"></table>
<table id="early_payments" class="hasdate"></table>
<table id="credit_draws" class="hasdate"></table>
<table id="skip_principal" class="hasdate"></table>
<pre>
<div id="item"></div>
</pre>
</body>
</html>
