<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- Copyright (c) 2014 - Bitquant Research Laboratories (Asia) --
  -- Ltd. -->
<!-- Redistributable under terms of the Simplified BSD License -->
<head>
<link href="https://code.jquery.com/ui/1.11.2/themes/ui-lightness/jquery-ui.css" rel="stylesheet"/>
<link href="jquery.appendGrid-1.5.0.min.css" rel="stylesheet"/>
<script src="http://requirejs.org/docs/release/2.1.15/minified/require.js"></script>
<script>
require.config({
    paths: {
        "moment": "node_modules/moment/moment",
	"jquery" : "http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min",
	"modernizr" : "http://cdn.jsdelivr.net/webshim/1.14.2/extras/modernizr-custom",
	"jquery-ui" : "http://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min",
	"append-grid" :  "jquery.appendGrid-1.5.0.min",
	"polyfiller" :    "http://cdn.jsdelivr.net/webshim/1.14.2/polyfiller",
	"markdown" :
    "http://cdnjs.cloudflare.com/ajax/libs/pagedown/1.0/Markdown.Converter.min",
	"collapse" : "jquery.collapse" 
    },
    shim: {
        "jquery-ui": {
            exports:"$" ,
            deps: ['jquery']
        },
	"markdown" : {
	    exports: "Markdown"
	},
        "append-grid": ['jquery-ui'],
        "collapse": ['jquery-ui'],
	"polyfiller" : {
	    exports: "webshims",
	    deps: ['modernizr']
	}
    },
    waitSeconds: 15
});

var analyze;

require ([
    "./TermSheet",
    "./LoanCalculator",
"markdown",
"append-grid",
"polyfiller",
"collapse"], function(TermSheet, LoanCalculator) {
    webshims.setOptions('forms-ext', {types: 'date'});
    var converter = new Markdown.Converter();
    var my_term_sheet = new TermSheet.TermSheet();
    $("#text").html(converter.makeHtml(my_term_sheet.contract_text));
    $("#text").collapse({query: 'h2'});

    analyze = function() {
        var events = {
	};
	my_term_sheet.event_spec.forEach(function(i) {
	    if (i.type == "grid") {
		var name = "#" + i.name + "_grid";
		events[i.name] = [];

		$(name).appendGrid('getAllValue').forEach(function(j) {
		    events.revenues.push(j);
		});
	    }
	});
	my_term_sheet.set_events(events);
	calculator = new LoanCalculator.LoanCalculator();
	$('#item').html("");
        var payments;
	try {
	    payments = calculator.calculate(my_term_sheet);
	    $('#item').html("");
	    calculator.show_payments(my_term_sheet).forEach(function(i) {
		$('#item').append(i.join(" "));
		$('#item').append("\n");
	    });
	} catch(err) {
	    $('#item').html(err.message);
	}
    };
    $(function() {
	my_term_sheet.event_spec.forEach(function(i) {
	    if (i.type == "grid") {
		var table = document.createElement('table');
		var name = i.name + "_grid";
		table.id = name;
		$("#event_inputs").append(table);
		$(table).appendGrid({
		     caption: i.display,
		     initRows: 0,
		     columns: i.columns,
		    afterRowInserted: function(caller,
					       parentRow,
					       addedRow) {
			$(caller).updatePolyfill();
		    },
		    afterRowAppended: function(caller,
					       parentRow,
					       addedRow) {
			$(caller).updatePolyfill();
		    }
		 });
	    }
	});
	webshims.polyfill('forms forms-ext es5');
    });
});

</script>

</head>
<body>

<h1>Smart Contract Analyzer</h1>
Copyright (c) 2014 - Bitquant Research Laboratories (Asia) Ltd.<br>
Redistributable under terms of the Simplified BSD License
<p>
<b>Please note that the smart contract analyzer does *NOT* form part of
the contract.</b>

<div id="text"></div>

<button id="btnSerialize" onclick="analyze()" type="button">Analyze</button>
<div id="event_inputs"></div>
<pre>
<div id="item"></div>
</pre>
</body>
</html>
